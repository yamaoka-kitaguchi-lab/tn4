#!/usr/bin/env python3

"""

tn4 - Titanet4 as Code

A command-line utility to repair NetBox and deploy Titanet4 with Ansible.

  * tn4 config - Rendering Jinja2 templates and exporting them as *.cfg files
  * tn4 deploy - Provisioning Titanet4 with Ansible fetching inventory from NetBox
  * tn4 shutdown - Shutting down Titanet4 in preparation for the campus-wide blackout
  * tn4 netbox - Scanning and repairing NetBox integrity and providing CLI-based operation

Since:   October 2022
Source:  https://github.com/yamaoka-kitaguchi-lab/tn4-player

"""

from argparse import ArgumentParser
import os
import sys

CURDIR       = os.path.dirname(__file__)
LIBRARY_PATH = os.path.join(CURDIR, "../lib")

sys.path.append(LIBRARY_PATH)

from tn4.cli.config import Config
from tn4.cli.deploy import Deploy
from tn4.cli.shutdown import Shutdown
from tn4.cli.netbox import NetBox


def csv_to_list(csv):
    if csv is None:
        return []
    return csv.split(",")


if __name__ == "__main__":
    parser = ArgumentParser()
    subparsers = parser.add_subparsers(title="commands", dest="command")

    parser1 = subparsers.add_parser("config",
                                    description="tn4 config - Rendering Jinja2 templates and exporting them as *.cfg files",
                                    help="Rendering Jinja2 templates and exporting them as *.cfg files",
                                    aliases=["co"])
    parser1.add_argument("--hosts",       type=str, help="limit the hosts")
    parser1.add_argument("--no-hosts",    type=str, help="exclude rule for --hosts")
    parser1.add_argument("--areas",       type=str, help="limit the hosts with specified regions or site groups (eg. ookayama-n,suzukake)")
    parser1.add_argument("--no-areas",    type=str, help="exclude rule for --areas")
    parser1.add_argument("--roles",       type=str, help="limit the hosts with specified device roles (eg. edge_sw)")
    parser1.add_argument("--no-roles",    type=str, help="exclude rule for --roles")
    parser1.add_argument("--vendors",     type=str, help="limit the hosts with specified manufacturers (eg. juniper)")
    parser1.add_argument("--no-vendors",  type=str, help="exclude rule for --vendors")
    parser1.add_argument("--tags",        type=str, help="limit the hosts with specified device tags (eg. test)")
    parser1.add_argument("--no-tags",     type=str, help="exclude rule for --tags")
    parser1.add_argument("-f", "--force", action="store_true", help="ignore all warnings and skip confirmation")
    parser1.add_argument("--use-cache",   action="store_true", help="skip NetBox fetching and use local cache if available")

    parser2 = subparsers.add_parser("deploy",
                                    description="tn4 deploy - Provisioning Titanet4 with Ansible fetching inventory from NetBox",
                                    help="Provisioning Titanet4 with Ansible fetching inventory from NetBox")
    parser2.add_argument("--hosts", type=str, help="limit the provisioning targets to specified hosts")
    parser2.add_argument("--no-hosts", type=str, help="exclude specified hosts from provisioning targets")
    parser2.add_argument("--areas", type=str, help="limit the provisioning targets to specified areas")
    parser2.add_argument("--no-areas", type=str, help="exclude specified areas from provisioning targets")
    parser2.add_argument("--roles", type=str, help="limit the provisioning targets to specified roles")
    parser2.add_argument("--no-roles", type=str, help="exclude specified roles from provisioning targets")
    parser2.add_argument("-f", "--force", action="store_true", help="ignore all warnings and skip confirmation")
    parser2.add_argument("--dry-run",     action="store_true", help="simulate a command without actually provisioning it")
    parser2.add_argument("--use-cache",   action="store_true", help="skip NetBox fetching and use local cache if available")

    parser3 = subparsers.add_parser("shutdown",
                                    description="tn4 shutdown - Shutting down Titanet4 in preparation for the campus-wide blackout",
                                    help="Shutting down Titanet4 in preparation for the campus-wide blackout")
    parser3.add_argument("--hosts", type=str, help="limit the shutdown targets to specified hosts")
    parser3.add_argument("--no-hosts", type=str, help="exclude specified hosts from shutdown targets")
    parser3.add_argument("--areas", type=str, help="limit the shutdown targets to specified areas")
    parser3.add_argument("--no-areas", type=str, help="exclude specified areas from shutdown targets")
    parser3.add_argument("--roles", type=str, help="limit the shutdown targets to specified roles")
    parser3.add_argument("--no-roles", type=str, help="exclude specified roles from shutdown targets")
    parser3.add_argument("--reboot", action="store_true", help="request reboot instead of system halt")
    parser3.add_argument("-f", "--force", action="store_true", help="ignore all warnings and skip confirmation")
    parser3.add_argument("--dryrun", action="store_true", help="simulate a command without actually shutdown it")
    parser3.add_argument("--use-cache", action="store_true", help="use cache if available")

    parser4 = subparsers.add_parser("netbox",
                                    description="tn4 netbox - Scanning and repairing NetBox integrity and providing CLI-based operation",
                                    help="Scanning and repairing NetBox integrity and providing CLI-based operation",
                                    aliases=["nb"])
    parser4.add_argument("--check", action="store_true", help="")
    parser4.add_argument("--repair", action="store_true", help="")
    parser4.add_argument("-v", "--versbose", action="store_true", help="")
    parser4.add_argument("-f", "--force", action="store_true", help="ignore all warnings and skip confirmation")
    parser4.add_argument("--dryrun", action="store_true", help="simulate a command without  provisioning it")
    parser4.add_argument("--use-cache", action="store_true", help="use cache if available")

    args = parser.parse_args()

    match args.command:
        case "config" | "deploy" | "shutdown" | "co":
            args.hosts = csv_to_list(args.hosts)
            args.no_hosts = csv_to_list(args.no_hosts)
            args.areas = csv_to_list(args.areas)
            args.no_areas = csv_to_list(args.no_areas)
            args.roles = csv_to_list(args.roles)
            args.no_roles = csv_to_list(args.no_roles)

    code = None
    match args.command:
        case "config" | "co":
            code = Config(args).exec(stdout=True)
        case "deploy":
            code = Deploy(args).exec(stdout=True)
        case "shutdown":
            code = Shutdown(args).exec(stdout=True)
        case "netbox":
            code = NetBox(args).exec(stdout=True)

    if code == 1:
        parser.print_help()

    sys.exit(code)

