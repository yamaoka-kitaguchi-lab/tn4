#!/usr/bin/env python3

"""

NBCK - NetBox Consistency Check

NBCK is a command-line utility to check and repair NetBox registration errors.
This makes sure NetBox for integrity and consistency just like the fsck command does for Linux filesystem.

$ PATH=$HOME/tn4-player/bin:$PATH
$ nbck --full-check --force-repair

Since: March 2022
See: https://github.com/yamaoka-kitaguchi-lab/tn4-player

"""

import click
from rich import box
from rich.console import Console
from rich.table import Table
from time import sleep


class NBCK:
    def __init__(self) -> None:
        self.console = Console()
        self.master_slave_tag_problems = None
        self.wifi_tag_problems = None

    def load_inventories(self, verbose=False) -> None:
        with self.console.status("[bold]Fetching the latest inventories from NetBox (netbox.m.noc.titech.ac.jp)..."):
            sleep(1)  # VLAN fetch
            self.console.log("Fetched all VLANs")
            sleep(1)  # IP Address fetch
            self.console.log("Fetched all IP Addresses")
            sleep(1)  # Device fetch
            self.console.log("Fetched all Devices")
            sleep(1)  # Interface fetch
            self.console.log("Fetched all Interfaces")


    def full_check(self, verbose=False) -> None:
        #with self.console.status("[bold]Finding broken consistency..."):
        #    self.__check_master_slave_tag_consistency()
        #    self.console.log(f"Checked Master/Slave tag consistency ({len(self.master_slave_tag_problems)} problems found)")

        #    self.__check_wifi_tag_consistency()
        #    self.console.log(f"Checked Wi-Fi tag consistency ({len(self.wifi_tag_problems)} problems found)")

        self.__print_problem_summary(self.master_slave_tag_problems)
        self.__print_problem_summary(self.wifi_tag_problems)


    def __print_problem_summary(self, problems) -> None:
        table = Table(show_header=True, header_style="bold red")
        table.box = box.SIMPLE
        table.add_column("#", style="dim")
        table.add_column("Hostname", style="bold")
        table.add_column("IP address", style="")
        table.add_column("Interface", style="bold")
        table.add_column("Violation", style="cyan")
        table.add_column("Current state", style="magenta")
        table.add_column("Desired state", style="green")
        for i in range(100):
            table.add_row(
                str(i),
                "s7-flets",
                "172.16.32.133",
                "GigabitEthernet0/1/20",
                "Master/Slave",
                "vlan100 vlan120 vlan130 description hoge"*1000,
                "x"*1000,
            )
        table.row_styles = ["none", "dim"]
        self.console.print(table)


    def full_repair(self, skip_confirm=False, verbose=False) -> None:
        with self.console.status("[bold]Repairing broken master/slave tag consistency..."):
            self.__repair(self.master_slave_tag_problems)
            self.console.log("Repaired all Master/Slave tag inconsistencies")

        with self.console.status("[bold]Repairing broken Wi-Fi tag consistency..."):
            self.__repair(self.wifi_tag_problems)
            self.console.log("Repaired all Wi-Fi tag inconsistencies")


    def __repair(self, problems) -> None:
        sleep(1)  # dummy


    def __check_master_slave_tag_consistency(self) -> None:
        sleep(1)  # dummy
        self.master_slave_tag_problems = [{}]


    def __check_wifi_tag_consistency(self) -> None:
        sleep(1)  # dummy
        self.wifi_tag_problems = [{}]


@click.command(help="A command-line utility to check and repair NetBox integrity and consistency")
@click.option("--force-repair", "flg_force_repair", is_flag=True, default=False, help="Repair all inconsistencies without confirmation")
@click.option("--verbose", "flg_verbose", is_flag=True, default=False, help="Show defailed logging")
def main(flg_force_repair, flg_verbose):
    nbck = NBCK()
    #nbck.load_inventories(verbose=flg_verbose)
    nbck.full_check(verbose=flg_verbose)
    #nbck.full_repair(skip_confirm=flg_force_repair, verbose=flg_verbose)


if __name__ == "__main__":
    main()
